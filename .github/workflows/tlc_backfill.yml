name: TLC Backfill + Monthly Refresh

on:
  workflow_dispatch:
    inputs:
      start_year:
        description: "Start year (e.g. 2024)"
        required: false
      start_month:
        description: "Start month (1-12)"
        required: false
      months_count:
        description: "How many months to process (e.g. 3, 12, 36)"
        required: false
        default: "36"

  schedule:
    # Runs monthly on the 2nd day at 02:15 UTC (adjust if you want)
    - cron: "15 2 2 * *"

jobs:
  run-backfill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Microsoft ODBC Driver 18
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backfill script
        env:
          STORAGE_ACCOUNT_URL: ${{ secrets.STORAGE_ACCOUNT_URL }}
          STORAGE_CONTAINER: ${{ secrets.STORAGE_CONTAINER }}
          STORAGE_ACCOUNT_KEY: ${{ secrets.STORAGE_ACCOUNT_KEY }}
          SQL_SERVER: ${{ secrets.SQL_SERVER }}
          SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
          SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
          SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}

          START_YEAR: ${{ github.event.inputs.start_year }}
          START_MONTH: ${{ github.event.inputs.start_month }}
          MONTHS_COUNT: ${{ github.event.inputs.months_count }}

        run: |
          python scripts/backfill_tlc_yellow.py
